<!-- All Modal Dialogs for End Users Management -->

<!-- Sync to Playtomic Modal -->
<div class="modal fade" id="syncPlaytomicModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cloud-upload"></i> Sync Active Users to Playtomic
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Integration Setup -->
                <div id="integrationStep">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-gear"></i> Step 1: Playtomic Integration Setup</h6>
                        <p class="mb-0">Configure your Playtomic integration tokens. These will be saved and automatically refreshed when needed.</p>
                    </div>

                    <div id="integrationForm">
                        <form id="playtomicIntegrationForm">
                            <div class="mb-3">
                                <label class="form-label">Access Token *</label>
                                <input type="text" id="integrationAccessToken" class="form-control"
                                       placeholder="Enter your Playtomic access token" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Access Token Expiration *</label>
                                <input type="number" id="integrationAccessTokenExpiration" class="form-control" required
                                       placeholder="Enter timestamp (e.g., 1754996632000)">
                                <small class="text-muted">Timestamp in milliseconds (will be converted to UTC DateTime)</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Refresh Token *</label>
                                <input type="text" id="integrationRefreshToken" class="form-control"
                                       placeholder="Enter your Playtomic refresh token" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Refresh Token Expiration *</label>
                                <input type="number" id="integrationRefreshTokenExpiration" class="form-control" required
                                       placeholder="Enter timestamp (e.g., 1786529032000)">
                                <small class="text-muted">Timestamp in milliseconds (will be converted to UTC DateTime)</small>
                            </div>
                        </form>
                    </div>

                    <div id="existingIntegration" class="d-none mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="bi bi-check-circle text-success"></i> Integration Configured</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">Access Token Expires:</small><br>
                                        <span id="displayAccessTokenExpiration"></span>
                                        <span id="accessTokenStatus" class="badge"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Refresh Token Expires:</small><br>
                                        <span id="displayRefreshTokenExpiration"></span>
                                        <span id="refreshTokenStatus" class="badge"></span>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="editIntegration()">
                                    <i class="bi bi-pencil"></i> Update Integration
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: User Sync -->
                <div id="syncStep" class="d-none">
                    <div class="alert alert-success">
                        <h6><i class="bi bi-cloud-upload"></i> Step 2: Sync Users to Playtomic</h6>
                        <ul class="mb-0">
                            <li>Export all active users (active subscription & not paused) to CSV format</li>
                            <li>Upload to Playtomic for each branch that has a Tenant ID configured</li>
                            <li>CSV includes: name, email, phone, category (Padel Pass), and subscription end date</li>
                        </ul>
                    </div>

                    <div id="syncPreview" class="card bg-light d-none">
                        <div class="card-body">
                            <h6>Sync Preview:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Active Users:</strong> <span id="previewActiveUsers">Loading...</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Branches with Tenant ID:</strong> <span id="previewBranches">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="syncProgress" class="d-none">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Syncing...</span>
                        </div>
                        <p class="mt-2">Syncing users to Playtomic... Please wait.</p>
                    </div>
                </div>

                <div id="syncResults" class="d-none">
                    <!-- Results will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                
                <!-- Integration Step Buttons -->
                <div id="integrationButtons">
                    <button type="button" id="saveIntegrationBtn" class="btn btn-success" onclick="saveIntegration()">
                        <i class="bi bi-save"></i> Save Integration
                    </button>
                </div>
                
                <!-- Sync Step Buttons -->
                <div id="syncButtons" class="d-none">
                    <button type="button" id="previewSyncBtn" class="btn btn-info" onclick="getSyncPreview()">
                        <i class="bi bi-eye"></i> Preview Sync
                    </button>
                    <button type="button" id="startSyncBtn" class="btn btn-warning d-none" onclick="startPlaytomicSyncWithIntegration()">
                        <i class="bi bi-cloud-upload"></i> Start Sync
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sync Playtomic User IDs Modal -->
<div class="modal fade" id="syncPlaytomicUserIdsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-repeat"></i> Sync Playtomic Users Id to CheckIn
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    This will fetch Playtomic category members and update missing PlaytomicUserId for local users. Existing IDs will not be overwritten.
                </div>
                <div id="syncPlaytomicUserIdsProgress" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Syncing...</span>
                    </div>
                    <p class="mt-2 mb-0">Syncing Playtomic User IDs...</p>
                </div>
                <div id="syncPlaytomicUserIdsResult" class="mt-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="CreateEndUser" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Add New End User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Name *</label>
                                <input type="text" name="Name" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Phone Number *</label>
                                <input type="tel" name="PhoneNumber" class="form-control" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" name="Email" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Image URL</label>
                                <input type="url" name="ImageUrl" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Subscription Period</h6>
                        <p class="mb-0">You can either set the duration in days (auto-calculated) or manually set the end date.</p>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Subscription Start Date *</label>
                                <input type="date" id="createStartDate" name="SubscriptionStartDate"
                                       class="form-control" required onchange="calculateEndDate()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Duration (Days)</label>
                                <input type="number" id="createDurationDays" name="SubscriptionDurationDays"
                                       class="form-control" min="1" max="1825" placeholder="e.g., 365" value="0"
                                       onchange="calculateEndDate()">
                                <small class="text-muted">Auto-calculates end date</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Subscription End Date *</label>
                                <input type="date" id="createEndDate" name="SubscriptionEndDate" class="form-control"
                                       required onchange="clearDuration()">
                                <small class="text-muted">Or set manually</small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning d-none" id="dateCalculationAlert">
                        <i class="bi bi-calculator"></i> <strong>Auto-calculated:</strong>
                        <span id="calculationDetails"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create End User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="UpdateEndUser" method="post">
                <input type="hidden" id="editId" name="id">
                <div class="modal-header">
                    <h5 class="modal-title">Edit End User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Name *</label>
                                <input type="text" id="editName" name="Name" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Phone Number *</label>
                                <input type="tel" id="editPhone" name="PhoneNumber" class="form-control" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" id="editEmail" name="Email" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Image URL</label>
                                <input type="url" id="editImageUrl" name="ImageUrl" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Subscription Period</h6>
                        <p class="mb-0">You can either set the duration in days (auto-calculated) or manually set the end date.</p>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Subscription Start Date *</label>
                                <input type="date" id="editStartDate" name="SubscriptionStartDate" class="form-control"
                                       required onchange="calculateEditEndDate()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Duration (Days)</label>
                                <input type="number" id="editDurationDays" name="SubscriptionDurationDays"
                                       class="form-control" min="1" max="1825" placeholder="e.g., 365"
                                       onchange="calculateEditEndDate()">
                                <small class="text-muted">Auto-calculates end date</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Subscription End Date *</label>
                                <input type="date" id="editEndDate" name="SubscriptionEndDate" class="form-control"
                                       required onchange="clearEditDuration()">
                                <small class="text-muted">Or set manually</small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning d-none" id="editDateCalculationAlert">
                        <i class="bi bi-calculator"></i> <strong>Auto-calculated:</strong>
                        <span id="editCalculationDetails"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update End User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Member QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <img id="qrCodeImage" src="" alt="QR Code" class="img-fluid" style="max-width: 300px;">
                </div>
                <div class="alert alert-info">
                    <p class="mb-2"><strong>Member ID:</strong> <span id="uniqueId"></span></p>
                    <small>This QR code can be scanned for quick check-in</small>
                </div>
                <button class="btn btn-primary btn-lg" onclick="downloadQR()">
                    <i class="bi bi-download"></i> Download QR Code
                </button>
                <hr>
                <p class="text-muted small">
                    <i class="bi bi-info-circle"></i> Save this QR code to your phone or print it for easy access at check-in.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- QR Link Modal for Mobile -->
<div class="modal fade" id="qrLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">QR Code Download Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    <strong>Success!</strong> QR code download link generated successfully.
                </div>

                <div class="mb-3">
                    <label class="form-label">Copy this link and share it:</label>
                    <div class="input-group">
                        <input type="text" id="qrDownloadLink" class="form-control" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyLinkFallback()">
                            <i class="bi bi-clipboard" id="copyIcon"></i> Copy
                        </button>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="openQRLink()">
                        <i class="bi bi-box-arrow-up-right"></i> Open QR Download Page
                    </button>
                    <button class="btn btn-outline-success" onclick="shareQRLink()" id="shareButton"
                            style="display: none;">
                        <i class="bi bi-share"></i> Share Link
                    </button>
                </div>

                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        The link can only be used once. Make sure to download the QR code when you open it.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Stop Subscription Modal -->
<div class="modal fade" id="stopSubscriptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-stop-circle"></i> Stop Subscription
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action will permanently stop the subscription. The user will no longer be able to check in.
                </div>

                <div class="mb-3">
                    <h6>User Information</h6>
                    <div class="bg-light p-3 rounded">
                        <p class="mb-1"><strong>Name:</strong> <span id="stopUserName"></span></p>
                        <p class="mb-0"><strong>Phone:</strong> <span id="stopUserPhone"></span></p>
                    </div>
                </div>

                <form id="stopSubscriptionForm">
                    <input type="hidden" id="stopEndUserId" name="endUserId"/>

                    <div class="mb-3">
                        <label for="stopReason" class="form-label">
                            <i class="bi bi-chat-text"></i> Reason for Stopping Subscription *
                        </label>
                        <textarea id="stopReason" name="stopReason" class="form-control" rows="4"
                                  placeholder="Please provide a reason for stopping this subscription (e.g., User requested cancellation, Payment issues, etc.)"
                                  required maxlength="500"></textarea>
                        <div class="form-text">Maximum 500 characters</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="submitStopSubscription()">
                    <i class="bi bi-stop-circle"></i> Stop Subscription
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stop Details Modal -->
<div class="modal fade" id="stopDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Subscription Stop Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-calendar-x"></i> Stopped Date:
                    </label>
                    <p id="stopDetailsDate" class="mb-0 text-muted"></p>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-chat-text"></i> Reason:
                    </label>
                    <div class="bg-light p-3 rounded">
                        <p id="stopDetailsReason" class="mb-0"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>
